<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Intelligent Question Generator</title>
    <!-- Load Tailwind CSS for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a; /* Slate 900 */
        }
        .container {
            max-width: 900px;
        }
        .loading-dot {
            animation: pulse 1.5s infinite;
        }
        .loading-dot:nth-child(2) { animation-delay: 0.5s; }
        .loading-dot:nth-child(3) { animation-delay: 1s; }
        @keyframes pulse {
            0%, 100% { opacity: 0.2; }
            50% { opacity: 1; }
        }
    </style>
</head>
<body>

<div id="app" class="container mx-auto p-4 md:p-8 min-h-screen flex flex-col items-center">

    <h1 class="text-4xl md:text-5xl font-extrabold text-blue-400 mb-6 text-center">
        ðŸ§  The Knowledge Explorer
    </h1>
    <p class="text-slate-400 text-center mb-10">
        Input a **Topic Name**, **Text**, or an **Image** to instantly generate deep, critical-thinking questions.
    </p>

    <!-- Input Section -->
    <div class="w-full bg-slate-800 p-6 rounded-xl shadow-2xl mb-8">
        <label for="text-input" class="block text-slate-200 text-lg font-semibold mb-2">
            1. Enter Text or Topic:
        </label>
        <textarea id="text-input" rows="5" class="w-full p-3 rounded-lg bg-slate-900 text-white border border-slate-700 focus:ring-blue-500 focus:border-blue-500 transition duration-150" placeholder="e.g., The core principles of quantum entanglement, or, Paste a full paragraph of text..."></textarea>

        <label for="file-upload" class="block text-slate-200 text-lg font-semibold mt-6 mb-2">
            2. Upload Image (Optional):
        </label>
        <div class="flex flex-col sm:flex-row items-start sm:items-center space-y-3 sm:space-y-0 sm:space-x-4">
            <input type="file" id="file-upload" accept="image/png, image/jpeg, .txt" class="block w-full text-sm text-slate-300
                file:mr-4 file:py-2 file:px-4
                file:rounded-full file:border-0
                file:text-sm file:font-semibold
                file:bg-blue-500 file:text-white
                hover:file:bg-blue-600 transition duration-150
            ">
            <span id="file-name" class="text-slate-400 text-sm italic">No file selected.</span>
        </div>
        <p class="text-xs text-slate-500 mt-2">Max file size for processing is 4MB.</p>
    </div>

    <!-- Generate Button -->
    <button id="generate-btn" class="w-full sm:w-1/2 flex items-center justify-center bg-green-500 hover:bg-green-600 text-black font-extrabold py-3 px-6 rounded-full shadow-lg transition duration-200 ease-in-out transform hover:scale-[1.01] mb-8 disabled:bg-slate-600 disabled:cursor-not-allowed">
        <span id="button-text">GENERATE QUESTIONS</span>
    </button>

    <!-- Status and Output Section -->
    <div id="status-message" class="text-center text-lg text-yellow-400 mb-4 h-6"></div>

    <div class="w-full bg-slate-800 p-6 rounded-xl shadow-2xl">
        <h2 class="text-2xl font-bold text-slate-200 mb-3">Generated Questions:</h2>
        <div id="output-area" class="min-h-[200px] w-full p-4 rounded-lg bg-slate-900 text-blue-300 border border-slate-700 whitespace-pre-wrap">
            The generated critical thinking questions will appear here after analysis.
        </div>
    </div>
</div>

<script>
    const API_MODEL = 'gemini-2.5-flash-preview-09-2025';
    const API_KEY = ""; // Canvas will provide this if empty
    const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${API_MODEL}:generateContent?key=${API_KEY}`;
    
    // UI Elements
    const textInput = document.getElementById('text-input');
    const fileUpload = document.getElementById('file-upload');
    const fileNameDisplay = document.getElementById('file-name');
    const generateBtn = document.getElementById('generate-btn');
    const statusMessage = document.getElementById('status-message');
    const outputArea = document.getElementById('output-area');
    const buttonText = document.getElementById('button-text');

    // --- Utility Functions ---

    /** Converts a file to a base64 string. */
    const fileToBase64 = (file) => {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result.split(',')[1]);
            reader.onerror = (error) => reject(error);
        });
    };

    /** Implements exponential backoff for fetch retries. */
    async function fetchWithRetry(url, options, maxRetries = 3) {
        for (let i = 0; i < maxRetries; i++) {
            try {
                const response = await fetch(url, options);
                if (response.status === 429 && i < maxRetries - 1) {
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    console.log(`Rate limit hit, retrying in ${delay / 1000}s...`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                    continue;
                }
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status} - ${response.statusText}`);
                }
                return response;
            } catch (error) {
                if (i === maxRetries - 1) throw error;
            }
        }
    }
    
    // --- Core Logic ---

    function updateStatus(message, isError = false) {
        statusMessage.textContent = message;
        statusMessage.className = `text-center text-lg mb-4 h-6 ${isError ? 'text-red-400' : 'text-yellow-400'}`;
    }

    function setGenerating(isGenerating) {
        generateBtn.disabled = isGenerating;
        if (isGenerating) {
            buttonText.innerHTML = `Generating <span class="loading-dot">.</span><span class="loading-dot">.</span><span class="loading-dot">.</span>`;
            generateBtn.classList.replace('bg-green-500', 'bg-slate-600');
            updateStatus("Analyzing input and generating questions...", false);
        } else {
            buttonText.textContent = "GENERATE QUESTIONS";
            generateBtn.classList.replace('bg-slate-600', 'bg-green-500');
            updateStatus("Ready for input.", false);
        }
    }

    async function generateQuestions() {
        setGenerating(true);
        outputArea.textContent = '...Analyzing and generating...';

        const text = textInput.value.trim();
        const file = fileUpload.files[0];

        if (!text && !file) {
            updateStatus("Please enter a topic/text or upload a file.", true);
            outputArea.textContent = 'The generated critical thinking questions will appear here after analysis.';
            setGenerating(false);
            return;
        }

        const systemPrompt = `You are a world-class academic tutor and question generator. Your task is to analyze the provided content (text, topic, or image data) and generate a minimum of 5, maximum of 10, highly relevant and diverse questions. The questions must cover different cognitive levels:
1.  **Comprehension:** Facts, definitions, main ideas.
2.  **Application:** How the concepts relate or can be used.
3.  **Critical Thinking/Analysis:** Asking 'why' or 'how', forcing comparison, evaluation, or deeper meaning.

Format the output clearly as a numbered list of questions, without any introductory or concluding text.`;

        let parts = [];
        let tools = undefined; // Use tools for search grounding

        try {
            if (file) {
                // Case 1: File Input (Image/Text)
                if (file.size > 4 * 1024 * 1024) {
                    throw new Error("File size must be less than 4MB.");
                }
                const mimeType = file.type;
                const base64Data = await fileToBase64(file);

                parts.push({ 
                    inlineData: {
                        mimeType: mimeType,
                        data: base64Data
                    }
                });

                // Add text prompt to guide the model on how to handle the image/file
                parts.push({ text: `Analyze this file (Image/Text) and generate questions based on its content: ${text}` });

            } else if (text) {
                // Case 2: Text/Topic Input
                const isTopic = text.split(' ').length < 8; // Heuristic to guess if it's a short topic name
                
                if (isTopic) {
                    // Use Google Search for grounding if it's likely a short topic
                    tools = [{ "google_search": {} }];
                    parts.push({ text: `Generate questions about the following topic using real-time information: ${text}` });
                } else {
                    // Use the text directly
                    parts.push({ text: `Generate questions based on the following text: "${text}"` });
                }
            }


            const payload = {
                contents: [{ parts: parts }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                tools: tools,
            };

            const response = await fetchWithRetry(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const result = await response.json();
            
            const generatedText = result.candidates?.[0]?.content?.parts?.[0]?.text || "Generation failed or returned no text.";
            
            outputArea.textContent = generatedText;
            updateStatus("âœ… Analysis Complete! Questions Generated.", false);

        } catch (error) {
            console.error("API Call Error:", error);
            outputArea.textContent = "An error occurred during generation. Please check the console for details or try a different input. (Did you upload a very large file?)";
            updateStatus(`âŒ Error: ${error.message}`, true);
        } finally {
            setGenerating(false);
        }
    }

    // --- Event Listeners and Initial Setup ---

    generateBtn.addEventListener('click', generateQuestions);

    fileUpload.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (file) {
            fileNameDisplay.textContent = `File: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`;
        } else {
            fileNameDisplay.textContent = 'No file selected.';
        }
    });

    // Initial Status Check
    setGenerating(false);

</script>
</body>
</html>